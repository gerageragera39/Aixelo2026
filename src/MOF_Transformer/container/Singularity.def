Bootstrap: docker
From: nvidia/cuda:12.1.1-cudnn8-runtime-ubuntu22.04

%files
    requirements.txt /opt/requirements.txt

%post
    export DEBIAN_FRONTEND=noninteractive
    # Use only -e since dash does not support pipefail
    set -e

    # 1. System dependencies
    apt-get update && apt-get install -y --no-install-recommends \
        python3 \
        python3-pip \
        python3-dev \
        git \
        ca-certificates \
        build-essential \
        && rm -rf /var/lib/apt/lists/*

    ln -s /usr/bin/python3 /usr/bin/python || true
    python3 -m pip install --upgrade pip setuptools wheel

    # 2. Pin Numpy and Pydantic BEFORE installing heavy libraries
    # This prevents conflicts with RDKit and lightning config issues
    python3 -m pip install "numpy<2.0" "pydantic<2.0"

    # 3. Install PyTorch 2.4.0 (REQUIRED for transformers in moftransformer)
    # Use version 2.4.0 to avoid "GenerationMixin" error
    python3 -m pip install torch==2.4.0+cu121 torchvision==0.19.0+cu121 torchaudio==2.4.0+cu121 --index-url https://download.pytorch.org/whl/cu121

    # 4. Install DGL 2.1.0
    python3 -m pip install dgl==2.1.0+cu121 -f https://data.dgl.ai/wheels/cu121/repo.html

    # 5. Chemistry stack
    python3 -m pip install rdkit-pypi dgllife pyyaml h5py torchdata

    # 6. Install remaining dependencies
    # This will install moftransformer and pytorch-lightning==1.9.5 from your requirements
    python3 -m pip install --no-cache-dir -r /opt/requirements.txt

%environment
    export DEBIAN_FRONTEND=noninteractive
    export PYTHONUNBUFFERED=1
    export OMP_NUM_THREADS=1
    export LC_ALL=C
    export PATH="/usr/local/bin:$PATH"